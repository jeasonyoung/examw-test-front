<!doctype html>
<html>
<head>
<title>模拟考场 考试系统题库</title>
<#include "common/loadPageJS.ftl" />
<!-- dialog -->
<link href="<@s.url "/resources/artDialog/ui-dialog.css"/>" rel="stylesheet" type="text/css">
<script type="text/javascript" src="<@s.url "/resources/artDialog/dialog-min.js"/>"></script>
<!-- scrollTo -->
<script type="text/javascript" src="<@s.url "/resources/jquery.scrollTo.js"/>"></script>
<!-- pager -->
<link href="<@s.url "/resources/front-default/pager.css"/>" rel="stylesheet" type="text/css">
<script type="text/javascript" src="<@s.url "/resources/jquery.pager.js"/>"></script>
</head>
<body>
<#include "common/item_with_answer.ftl"/>
<#include "common/head.html" />
<div class="main">
	<div class="h30"></div>
	<div class="content fl">
    	<div class="cont-l fl" id="leftArea">
        	<div class="box fl yinying">
            	<div class="list">
                	<ul>
                        <li class="txt">您的得分</li>
                        <li class="txt"><div class="defen">${PAPER.userScore}</div></li>
                        <li class="bb-no"><a href="javascript:void(0)" onclick="showOnlyWrong(this)"><em class="kancuo-a"></em>只看错题</a></li>
                        <!--"只看错题"点击后的样式<li class="bb-no"><a href="#"><em class="kancuo-h"></em>只看错题</a></li>-->
                    </ul>
                </div>
            </div>
        	<div class="box fl yinying">
                <div class="hui-botton"><a href="错题记录.html">错题记录</a></div>
                <div class="dangqian">试题解析</div>
                <div class="hui-botton"><a href="#">再测试一次</a></div>
                <div class="h10"></div>
                <div class="list">
                	<ul>
                        <li class="bb-no"><a href="#"><em class="back"></em>返回列表</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="cont-r fr f-f14" id="paper_body">
        	<div class="box fl yinying">
            	<div class="daxiao">
                	<div class="list">
                    	<ul id="fontset">
                        	<li id="f-f14" current="true" class="out bg" onMouseOver="this.className='over bg'" onMouseOut="this.className='out bg'"><a href="#">小</a></li>
                            <li id="f-f16" class="out" onMouseOver="this.className='over'" onMouseOut="this.className='out'"><a href="#">中</a></li>
                            <li id="f-f18" class="out" onMouseOver="this.className='over'" onMouseOut="this.className='out'"><a href="#">大</a></li>
                            <li>字体大小:</li>
                        </ul>
                    </div>
                </div>
            	<div class="name"><h1>${PAPER.name}</h1></div>
                <div class="h20"></div>
                <div class="shuoming" >
                	<p>&gt; 本卷共分为${PAPER.structures?size}大题 ${PAPER.total}小题，作答时间为${PAPER.time}分钟，总分${PAPER.score}分，${PAPER.score*0.6}分及格。</p>
                    <p>&gt; 试卷来源：${PAPER.sourceName}</p>
                </div>
                <div class="tixing fl">
                	<div class="list">
                    	<ul>
                    		<#list PAPER.structures as structure>
                    		<#if structure_index == 0>
                        	<li><a class="bg" href="javascript:void(0)" onclick="chooseRule(this,'${structure.id}');">${structure.title}</a></li>
                        	<#else>
                        	<li><a href="javascript:void(0)" onclick="chooseRule(this,'${structure.id}');">${structure.title}</a></li>
                        	</#if>
                        	</#list>
                        </ul>
                    </div>
                </div>
            </div><a name="danxiang" id="danxiang"></a>
            <#list PAPER.structures as structure>
            <#assign total = total + structure.total/> 
            <#assign xuhao = total-structure.total + 1 />
            <div class="tx-box fl" structure_id="${structure.id}">${structure.title}</div>
            <#list structure.items?sort_by(["orderNo"]) as i>
            	<#if i.type != TYPE_SHARE_TITLE_VALUE && i.type != TYPE_SHARE_ANSWER_VALUE>
            		<@show_item father=null item=i index=(i_index+xuhao)/>
            	<#else>
            		<@show_item father=null item=i index=xuhao/>
            	</#if>
            </#list>
            </#list>
            <div class="datika fl" id="answerCard" style="width:830px;">
            	<div class="ka fl" id="font14">展开答题卡</div>
                <div class="ka-ge fl"></div>
                <div class="ka-box fl" style="display:none">
                	<@answer_card ITEMLIST />
                </div>
            </div>
        </div>
    </div>
    <div class="h30"></div>
</div>
<#include "common/foot.html" />
</body>
<script type="text/javascript">
<!-- 浮动,参数isTop是否距离顶部,否表示距离底部 -->
$.fn.smartFloat = function(isTop) {
	var position = function(element) {
		var top = element.position().top,left =element.position().left, pos = element.css("position");
		var height = $(this).height();
		$(window).scroll(function() {
			var scrolls = $(this).scrollTop();
			var flag;
			if(isTop) flag = scrolls-top;
			else flag = top-height-scrolls;
			if (flag > 0) { //如果滚动到页面超出了当前元素element的相对页面顶部的高度
				if (window.XMLHttpRequest) { //如果不是ie6
					if(isTop) element.css({position: "fixed",left:left,top: 0});
					else
					element.css({
						position: "fixed",
						left:left,
						bottom: 0
					});	
				} else { //如果是ie6
					if(isTop) element.css({position: "absolute",left:left,top: scrolls});
					else
					element.css({
						position: "absolute",
						left:left,
						bottom: 0
					});	
				}
			}else {	//滑到了底部
				if(isTop) element.css({position: pos,left:left,top: top});
				else
				element.css({
					position: pos,
					left:left,
					bottom: top
				});	
			}
		});
	};
	return $(this).each(function() {
		position($(this));						 
	});
};
$(function(){
	//var obj = '${PAPERJSON}';
	//console.info(obj);
	window.tempChooseAnswer = "";
	var paperId = "${PAPER.id}";
	var productId = "${PRODUCTID}";
	var totalNum = Number("${PAPER.total}");
	$("#answerCard").smartFloat(false);	//答题卡浮动
	$("#leftArea").smartFloat(1);//左侧浮动
	//<!-- 答题卡点击显示  -->
	$("#answerCard div").first().click(function(){
		var card = $(this).siblings("div").last();
		if(card.is(":hidden"))
		{
			$(this).html("隐藏答题卡");
			card.show();
		}
		else{
			$(this).html("展开答题卡");
			card.hide();
		}
	});
	//<!-- 字体选择 -->
	$("#fontset li").click(function(){
		if($(this)==$("#fontset li[current='true']")) return;
		$(this).addClass("bg").attr("current",'true');
		$("#paper_body").addClass($(this).attr("id")).removeClass($("#fontset li[current='true']").attr("id"));
		$(this).siblings().removeClass("bg").attr("current",'false');
	});
	//<!-- timer -->
	//<!-- 滑动到目标题目 -->
	focusTo = function(obj,index){
		var target = $("div[item_id='"+$(obj).attr("item_id")+"']");
		$.scrollTo(target,800,{axis:'y', offset:-20 });
		
	}
	//<!-- 切换大题 -->
	chooseRule = function(obj,id){
		var target = $("div[structure_id='" + id + "']");
		$(obj).addClass("bg");
		$(obj).parent().siblings().children().removeClass("bg");
		$.scrollTo(target,800,{axis:'y', offset:-20 });
	}
	//<!-- 查看材料 -->
	showCommonTitle = function(id){
		dialog({
			id:'cailiaoDialog',
			title: '查看材料',
			drag: true,
	        content: "<div class='cont-r'><div class='fenxiti fl' style='border:0px'>"+$("div[fenxi_item_id='"+id+"']").html()+"</div></div>",
	    }).show();
	}
	//<!-- 显示收起解析 -->
	toggleAnalysis = function(obj,id){
		var target = $("div[name='jiexi'][item_id='"+id+"']");
		if(target.is(":hidden")){
			target.show();
			$(obj).html("收起解析");
			$(obj).parent().siblings("em").attr("class","jiexi-h");
			$("div[class='zhankai-bg'][item_id='"+id+"']").show();
		}else{
			target.hide();
			$(obj).html("展开解析");
			$(obj).parent().siblings("em").attr("class","jiexi");
			$("div[class='zhankai-bg'][item_id='"+id+"']").hide();
		}
	}
	//<!-- 只看错题 -->
	showOnlyWrong = function(obj){
		if($(obj).find("em").attr("class")=="kancuo-h"){
			$(obj).find("em").attr("class","kancuo-a");
			$("div[item_status='1']").show();
			$("#answerCard li[item_status='1']").css("visibility","visible");
		}else{
			$(obj).find("em").attr("class","kancuo-h");
			$("div[item_status='1']").hide();
			$("#answerCard li[item_status='1']").css("visibility","hidden");
		}
	}
	//<!-- 分页 -->
	var pageClick = [];
	showNote = function(itemId,itemIndex,model){
		var index = pageClick.length;
		$.ajax({
			type:"POST",
			url:'<@s.url "/library/item/notes"/>',
			data:{"itemId":itemId,"page":1,"rows":3,"model":model},
			dataType:"json",
			success:function(data){
				if(data.total == 0) return;
				var arr = data.rows;
				var total = data.total%3==0?(data.total/3):(data.total/3+1);
				var contentArea = $("div[name='noteList'][s_item_id='"+itemId+"']").find("div[name='content']");
				contentArea.html("");
				$.each(arr,function(i){
					var note = arr[i];
					var html = "<div class='textbook fl'><div class='txt'><div class='pic-bg'><a href='#' target='_blank' title=''></a></div><div class='pic'><img src='<@s.url '/resources/front-default/image/pic2.jpg'/>' width='70' height='70'></div><div class='f-right'><div class='vipname fl'><a href='#' target='_blank' title='note.username'>"+note.username+"</a><span>"+note.time+"</span></div><div class='pinglun fl'>"+note.content+"</div></div></div></div>"
					contentArea.append(html);
				});
				if(data.total<=3){
					$("#pager"+itemIndex).html("");
				}else{
					pageClick[index] = function(pageclickednumber){
						$("#pager"+itemIndex).pager({ pagenumber: pageclickednumber, pagecount: total, buttonClickCallback: pageClick[index] });
						$.ajax({
							type:"POST",
							url:"<@s.url "/library/item/notes"/>",
							data:{"itemId":itemId,"page":pageclickednumber,"rows":3,"model":model},
							dataType:"json",
							success:function(data){
								if(data.total == 0) return;
								var arr = data.rows;
								var total = data.total%3==0?(data.total/3):(data.total/3+1);
								var contentArea = $("div[name='noteList'][s_item_id='"+itemId+"']").find("div[name='content']");
								contentArea.html("");
								$.each(arr,function(i){
									var note = arr[i];
									var html = "<div class='textbook fl'><div class='txt'><div class='pic-bg'><a href='#' target='_blank' title=''></a></div><div class='pic'><img src='<@s.url '/resources/front-default/image/pic2.jpg'/>' width='70' height='70'></div><div class='f-right'><div class='vipname fl'><a href='#' target='_blank' title='note.username'>"+note.username+"</a><span>"+note.time+"</span></div><div class='pinglun fl'>"+note.content+"</div></div></div></div>"
									contentArea.append(html);
								});
							}
						});
					}
					$("#pager"+itemIndex).pager({ pagenumber: 1, pagecount: total, buttonClickCallback: pageClick[index]});
				}
			}
		});	//获取数据
		$("div[name='noteList'][s_item_id='"+itemId+"']").show();
	}
	//<!-- 收藏或取消收藏 -->
	collectOrCancel = function(obj,itemId,userAnswer){
		var pid = $(obj).attr("pid");
		if(pid) itemId = pid+"#"+itemId;
		$.ajax({
			type:"POST",
			url:'<@s.url "/library/item/collect"/>',
			data:{"itemId":itemId,"userAnswer":userAnswer,"productId":productId,"paperId":paperId},
			dataType:'json',
			success:function(data){
				if(data.success){
					if(data.data == 0) //取消收藏成功
					{
						$(obj).parent().siblings().attr("class","shoucang");
						$(obj).html("收藏");
						showTips(obj,"取消收藏成功!");
					}
					else{
						$(obj).parent().siblings().attr("class","shoucang-h");
						$(obj).html("移除此收藏");
						showTips(obj,"收藏成功，您可以到“练习记录中”去查看收藏的试题！");
					}
				}
			}
		});
	}
	//显示提示
	function showTips(obj,msg){
		var d = dialog({
		    content: msg,
		    quickClose: true// 点击空白处快速关闭
		});
		d.show(obj);
	}
	// 添加笔记
	addNote = function(obj){
		var textarea = $(obj).parent().parent().find("textarea");
		if(!$.trim(textarea.val()) || textarea.val().length<6){
			showTips(obj,"请输入笔记内容(至少5个字)!");
			return;
		}
		$.ajax({
			type:"POST",
			url:"<@s.url "/library/item/addnote"/>",
			data:{"content":textarea.val(),"itemId":textarea.attr("item_id")},
			dataType:"json",
			success:function(data){
				if(data.success){
					var note = data.data;
					var html = "<div class='textbook fl'><div class='txt'><div class='pic-bg'><a href='#' target='_blank' title=''></a></div><div class='pic'><img src='<@s.url '/resources/front-default/image/pic2.jpg'/>' width='70' height='70'></div><div class='f-right'><div class='vipname fl'><a href='#' target='_blank' title='note.username'>"+note.username+"</a><span>"+note.time+"</span></div><div class='pinglun fl'>"+note.content+"</div></div></div></div>"
					var contentArea = $("div[name='noteList'][s_item_id='"+textarea.attr("s_item_id")+"']").find("div[name='content']");
					contentArea.prepend(html);
					$("div[name='noteList'][s_item_id='"+textarea.attr("s_item_id")+"']").show();
					textarea.val("");
				}
			}			
		});
	}
});
</script>
</html>